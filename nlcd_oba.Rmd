---
title: "nlcd_oba"
author: "egb"
date: "2024-11-20"
output:
  pdf_document: default
  html_document: default
---
```{r load-libraries, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
library(terra)
library(ggplot2)
library(dplyr)
library(sf)
```


NOTES from conversation with Lauren:  

- diversity of habitat types  
- don't subset to the two categories  

- calculate diversity at 100, 500, 1000 meters (changing buffer size) 
- a Buffer around every single bee (hypothetical place every bee would forage in) 
- find the pixel diversity in each of those buffers (to see if habitat heterogeneity improves bee diversity) 

- different generae associated with different habitat  

- in each buffer: number of species / number of observations (richness/diversity) 
      - richness factoring in variability in data collection 
      - relative richness to the number of observations  
      
- Split up the whole state / every bee observation into three elevational segments/bands  
- Look and bin some of the landcover data  
- Abundance-weight the pixels (shannon's, matrixes of diversity) 
- Use extract to create buffers  
- Don't do the label shuffling; use R lm() function  
- diversity begets diversity ecology (DBD) theory : paper that supports our research 

# 1. OBA Manipulation

```{r oba-import}

# Import OBA data:

oba <-
  read.csv("data/OBA_2018-2023_combined_dataset_working.csv")

```

```{r}
# Segment OBA data: 

# - Metadata we need:
#   - `Species`: The taxonomic identification of each bee (group of closely related species)
#   - `Genus`: The taxonomic identification of each bee (specific type within Genus)
#   - `Elevation`: The elevation (in meters) at which each bee was collected.
#   - `Coordinates`: Latitude (`Dec.Lat.`) and longitude (`Dec.Long.`) in decimal degrees.


# Subset oba data to our needed metadata
oba <- select(oba, Genus, Species, Dec..Lat., Dec..Long., Elevation..m.)
colnames(oba) <- c("Genus", "Spec", "Lat", "Long", "Elev")

# head(oba, 60)

# row count before cleaning: 195788
# nrow(oba)

```


```{r}
# Clean OBA data

# Remove elevation rows with null values 

for (col in colnames(oba)) {
  oba <- oba[oba[[col]] != "", ]
  oba <- oba[!is.na(oba[[col]]), ]
}
# Number of rows after cleaning: 41643
nrow(oba)

head(oba, 10)
```



```{r}
# Combine genus & species 
GenusSpec <- paste(oba$Genus, oba$Spec, sep=" ")

oba <- oba %>%
  mutate(GenusSpec)

colnames(oba)

head(oba, 10)
```


# 2. NLCD Manipulation

```{r nlcd-import, include=FALSE}
library(raster)

# Observe the dataset metadata here: https://www.arcgis.com/sharing/rest/content/items/9bbaa64718774bbfbf5c6ade0edf86d3/info/metadata/metadata.xml?format=default&output=html 

# Load landcover data as raster 
nlcd <- rast("data/NLCD_2016_Land_Cover_OR/NLCD_2016_Land_Cover_OR.img")


# LOWER RESOLUTION AND CREATE DF:
# Check original resolution
# Original: 98.4252 98.4252 
original_res <- res(nlcd)
# cat("Original resolution:", original_res, "\n")

# Create a new template raster with the desired resolution
# The larger the resolution, the easier to load (make this smaller for final run)
target_res <- 500  # Desired resolution in map units (e.g., meters)
extent_nlcd <- ext(nlcd)  # Get the extent of the original raster

# Create an empty raster template
template <- rast(extent = extent_nlcd, res = target_res, crs = crs(nlcd))

# Resample the original raster to match the new template
nlcd_resampled <- resample(nlcd, template, method = "near")  # Use "bilinear" for continuous data or "near" for categorical

print(nlcd_resampled)

# Convert raster to data frame for plotting 
nlcd_df <- as.data.frame(nlcd_resampled, na.rm = TRUE, xy = TRUE)

# Observe dataframe columns 
head(nlcd_df, 50)

# Add land cover type labels
# nlcd_df <-nlcd_df %>%
#   mutate(LandType = case_when(
#     Layer_1 == 43.0 ~ "Mixed Forest",
#     Layer_1 == 71.0 ~ "Grassland"
#     # Add more labels here for each land use
#   )) %>%
#   filter(!is.na(LandType))
```


# 3. Spational Integration
## Perform a spatial overlay to assign land cover types from NLCD to OBA points.

```{r}
# Spatial Integration
```


# 4. Elevational Band Categorization
## Define elevation bands using quantiles (Low, Middle, High).
## Assign OBA observations to corresponding elevation bands.


# 5. Statistical Analysis
## A/B testing framework to compare pollinator diversity between Mixed Forest and Grassland across elevation bands.
