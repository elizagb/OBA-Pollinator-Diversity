---
title: "nlcd_oba"
author: "egb"
date: "2024-11-20"
output:
  pdf_document: default
  html_document: default
---
```{r load-libraries, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
library(terra)
library(ggplot2)
library(dplyr)
library(sf)
```


# 1. OBA Manipulation

```{r oba-import}

# Import OBA data:

oba <-
  read.csv("data/OBA_2018-2023_combined_dataset_working.csv")

```

```{r}
# Segment OBA data: 

# - Metadata we need:
#   - `Species`: The taxonomic identification of each bee (group of closely related species)
#   - `Genus`: The taxonomic identification of each bee (specific type within Genus)
#   - `Elevation`: The elevation (in meters) at which each bee was collected.
#   - `Coordinates`: Latitude (`Dec.Lat.`) and longitude (`Dec.Long.`) in decimal degrees.


# Subset oba data to our needed metadata
oba <- select(oba, Genus, Species, Dec..Lat., Dec..Long., Elevation..m.)
colnames(oba) <- c("Genus", "Spec", "Lat", "Long", "Elev")

# head(oba, 60)

# row count before cleaning: 195788
# nrow(oba)

```


```{r}
# Clean OBA data

# Remove elevation rows with null values 

for (col in colnames(oba)) {
  oba <- oba[oba[[col]] != "", ]
  oba <- oba[!is.na(oba[[col]]), ]
}
# Number of rows after cleaning: 41643
nrow(oba)

head(oba, 10)

# Converting Elevation values to numeric 
oba$Elev <- as.numeric(oba$Elev)

```



```{r}
# Combine genus & species 
GenusSpec <- paste(oba$Genus, oba$Spec, sep=" ")

oba <- oba %>%
  mutate(GenusSpec)

colnames(oba)

head(oba, 10)
```


# 2. NLCD Manipulation

```{r nlcd-import, include=FALSE}

library(terra)
library(ggplot2)


# Observe the dataset metadata here: https://www.arcgis.com/sharing/rest/content/items/9bbaa64718774bbfbf5c6ade0edf86d3/info/metadata/metadata.xml?format=default&output=html 

# Load landcover data as raster 
nlcd <- rast("data/NLCD_2016_Land_Cover_OR/NLCD_2016_Land_Cover_OR.img")

# Aggregate the resolution so it loads faster 
# 'fact' defines the aggregation factor (e.g., 2 means 2x2 cells are combined into 1)
nlcd <-aggregate(nlcd, fact = 20, fun = "median")

```

```{r}
# Reproject to match OBA dataset CRS
nlcd <- project(nlcd, "EPSG:4326")

# Classify and filter for specific land cover types
classification_matrix <- matrix(c(
  -Inf, 42, NA,   # Remove values < 43
  43, 43, 43,     # Mixed Forest
  44, 70, NA,     # Remove irrelevant values
  71, 71, 71,     # Grassland
  72, Inf, NA     # Remove values > 71
), ncol = 3, byrow = TRUE)

nlcd <- classify(nlcd, rcl = classification_matrix)

# Convert raster to data frame for plotting and add labels
nlcd_df <- as.data.frame(nlcd, xy = TRUE, na.rm = TRUE) %>%
  rename(LandType = Layer_1) %>%
  mutate(LandType = case_when(
    LandType == 43 ~ "Mixed Forest",
    LandType == 71 ~ "Grassland"
  ))

```



# 3. Spational Integration
## Perform a spatial overlay to assign land cover types from NLCD to OBA points.

```{r}
# Spatial Integration

# Convert OBA data to spatial points
oba_sf <- st_as_sf(oba, coords = c("Long", "Lat"), crs = 4326)

# Extract land cover values at OBA point locations
oba_landcover <- terra::extract(nlcd, vect(oba_sf), bind = TRUE)

# Add extracted land cover types to OBA dataset
oba <- cbind(oba, LandType = oba_landcover$Layer_1) %>%
  mutate(LandType = case_when(
    LandType == 43 ~ "Mixed Forest",
    LandType == 71 ~ "Grassland",
    TRUE ~ NA_character_  # Default to NA if no condition is met
  )) %>%
  filter(!is.na(LandType))  # Keep only relevant land cover types

head(oba, 100)
nrow(oba)


```


# 4. Elevational Band Categorization
## Define elevation bands using quantiles (Low, Middle, High).
## Assign OBA observations to corresponding elevation bands.

```{r}
# # Define elevation quantiles and assign bands
# # Dividing the data into quantiles
# quantiles <- quantile(oba$Elev, probs = c(0.33, 0.66), na.rm = TRUE)
# 
# oba <- oba %>%
#   mutate(ElevBand = case_when(
#     Elev <= quantiles[1] ~ "Low",
#     Elev <= quantiles[2] ~ "Middle",
#     TRUE ~ "High" # Default is no previous condition is met 
#   ))
# 
# # Visualize elevation distribution
# ggplot(oba, aes(x = Elev, fill = ElevBand)) +
#   geom_histogram(binwidth = 50) +
#   theme_minimal() +
#   labs(title = "Elevation Bands", x = "Elevation (m)", y = "Count")

# Calculate Q1, Q2 (mean), and Q3
elev_stats <- quantile(oba$Elev, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
q1 <- elev_stats[1]
q2 <- elev_stats[2]
q3 <- elev_stats[3]

elev_stats

oba <- oba %>%
  mutate(
    ElevBand = case_when(
      Elev >= (q1 - 50) & Elev <= (q1 + 50) ~ "Low",
      Elev >= (q2 - 50) & Elev <= (q2 + 50) ~ "Middle",
      Elev >= (q3 - 50) & Elev <= (q3 + 50) ~ "High",
      TRUE ~ NA_character_
    )
  )

head(oba, 100)

sum(oba$ElevBand == "Low", na.rm = TRUE)
# sum(oba$ElevBand == "Low" & oba$LandType == "Grassland", na.rm = TRUE)

```
```{r}

nrow(oba)

low_band_data <- oba %>%
  filter(ElevBand == "Low")

library(ggplot2)

ggplot(oba, aes(x = Long, y = Lat, color = LandType)) +
  geom_point(size = 2, alpha = 0.8) +
  scale_color_manual(values = c("Mixed Forest" = "forestgreen", "Grassland" = "gold")) +
  theme_minimal() +
  labs(
    title = "Bee Observations in the Lower Elevational Band",
    x = "Longitude",
    y = "Latitude",
    color = "Land Type"
  )

```



# 5. Statistical Analysis
## A/B testing framework to compare pollinator diversity between Mixed Forest and Grassland across elevation bands.
